# 1. Django命令

## 1.1 创建 Django 项目相关

+ py manage.py startapp app名  # 创建Django应用
+ py manage.py makemigrations appname [可选: 自定义迁移文件名]  # 修改模型文件后产生迁移文件
+ py manage.py migrate appname [可选: 对应的迁移文件名]  # 生成表到数据库
+ py manage.py createcachetable  # 创建缓存表
+ py manage.py test appname  # 测试app

## 1.2 启动 Django项目相关

+ py manage.py runserver  # 启动django项目
+ py manage.py sqlmigrate appname 迁移文件名  # 接收一个迁移的名称，返回对应的sql
+ py manage.py check  # 检查项目中的问题（不会对数据库进行任何操作）
+ py manage.py shell  # 进入python命令行
+ py manage.py migrate admin  # 生成管理员相关表
  + py manage.py createsuperuser  # 创建能登陆（django自带）管理界面的用户

## 1.3 常见错误解决

+ 登录 django 后台管理界面提示 django_session 表不存在
  + 重新执行 migrate 命令

# 2. Django 要点

## 2.1 settings.py 作用

+ 注册APP
+ 配置数据库连接
+ 设置管理界面时区和语言
+ 为了成功引用静态文件在最后添加
  + STATICFILES_DIRS = [os.path.join(BASE_DIR, 'static'),]

### 示例：setting.py

+ ```python
  """
  Django settings for YiXuan project.
  
  Generated by 'django-admin startproject' using Django 3.0.5.
  
  For more information on this file, see
  https://docs.djangoproject.com/en/3.0/topics/settings/
  
  For the full list of settings and their values, see
  https://docs.djangoproject.com/en/3.0/ref/settings/
  """
  
  import os
  
  # Build paths inside the project like this: os.path.join(BASE_DIR, ...)
  BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
  
  
  # Quick-start development settings - unsuitable for production
  # See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/
  
  # SECURITY WARNING: keep the secret key used in production secret!
  SECRET_KEY = 's3o0v7!&*%ljy+9v*8l+d7f8sq6j!r0n160e#4sx$au=zg(g!l'
  
  # SECURITY WARNING: don't run with debug turned on in production!
  DEBUG = True
  
  ALLOWED_HOSTS = ['*']
  
  # Application definition
  INSTALLED_APPS = [
      'django.contrib.admin',
      'django.contrib.auth',
      'django.contrib.contenttypes',
      'django.contrib.sessions',
      'django.contrib.messages',
      'django.contrib.staticfiles',
  
      # add your apps
      'serialnumber',
      'douban'
  ]
  
  MIDDLEWARE = [
      'django.middleware.security.SecurityMiddleware',
      'django.contrib.sessions.middleware.SessionMiddleware',
      'django.middleware.common.CommonMiddleware',
      'django.middleware.csrf.CsrfViewMiddleware',
      'django.contrib.auth.middleware.AuthenticationMiddleware',
      'django.contrib.messages.middleware.MessageMiddleware',
      'django.middleware.clickjacking.XFrameOptionsMiddleware',
  ]
  
  ROOT_URLCONF = 'YiXuan.urls'
  
  TEMPLATES = [
      {
          'BACKEND': 'django.template.backends.django.DjangoTemplates',
          'DIRS': [os.path.join(BASE_DIR, 'templates')]
          ,
          'APP_DIRS': True,
          'OPTIONS': {
              'context_processors': [
                  'django.template.context_processors.debug',
                  'django.template.context_processors.request',
                  'django.contrib.auth.context_processors.auth',
                  'django.contrib.messages.context_processors.messages',
              ],
          },
      },
  ]
  
  WSGI_APPLICATION = 'YiXuan.wsgi.application'
  
  
  # Database
  # https://docs.djangoproject.com/en/3.0/ref/settings/#databases
  
  DATABASES = {
      # 'default': {
      #     'ENGINE': 'django.db.backends.sqlite3',
      #     'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
      # }
      'default': {
          'ENGINE': 'django.db.backends.mysql',
          'NAME': 'yixuan',
          'USER': 'root',
          'PASSWORD': '123456',
          'HOST': 'localhost',
          'PORT': '3306',
  
      }
  }
  
  
  # Password validation
  # https://docs.djangoproject.com/en/3.0/ref/settings/#auth-password-validators
  
  AUTH_PASSWORD_VALIDATORS = [
      {
          'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
      },
      {
          'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
      },
      {
          'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
      },
      {
          'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
      },
  ]
  
  
  # Internationalization
  # https://docs.djangoproject.com/en/3.0/topics/i18n/
  
  LANGUAGE_CODE = 'en-us'
  
  # TIME_ZONE = 'UTC'
  TIME_ZONE = 'Asia/Shanghai'
  
  USE_I18N = True
  
  USE_L10N = True
  
  USE_TZ = True
  
  
  # Static files (CSS, JavaScript, Images)
  # https://docs.djangoproject.com/en/3.0/howto/static-files/
  
  STATIC_URL = '/static/'
  STATICFILES_DIRS = [
      os.path.join(BASE_DIR, 'static'),
  ]
  
  # 缓存Session
  SESSION_ENGINE = 'django.contrib.sessions.backends.cache'  # 引擎
  SESSION_CACHE_ALIAS = 'default'                            # 使用的缓存别名（默认内存缓存，也可以是memcache），此处别名依赖缓存的设置
  SESSION_COOKIE_AGE = 3600                                 # Session的cookie失效日期（一天：60*60*24）
  SESSION_EXPIRE_AT_BROWSER_CLOSE = False                    # 是否关闭浏览器使得Session过期
  SESSION_SAVE_EVERY_REQUEST = False                         # 是否每次请求都保存Session，默认修改之后才保存
  ```

## 2.2 urls.py 作用

- 根目录中的 urls 文件中可以包含某个app中的 urls 文件
- 定义主页以及其他页面
- urls 文件中 path 的name = 'home' 是为了方便<a>标签的href 属性调用（例如: {% url ‘name’ %}）

## 2.3 APP 中各文件说明

1. models.py：通过实体类生成字段到数据库，产生迁移文件
2. views.py：引用model层封装视图，返回某个 html页面 或者 方法
3. urls.py：定义url名称，调用并传参给视图中的方法
4. admin.py：配置django自带的后台管理界面

## 2.4 HTML 中各种写法

1. {% extends 'base.html' %}：引用母版页
2. {% load staticfiles %}：加载静态文件
3. {% block title %} 内容（母版页这里内容为空） {% endblock %}
   - 解释：
   - title：是自定义名称
   - 内容：子页面用自己的内容替换母版页（内容可以是<link>引用样式或者<div>等其他内容）
4. <a href="{% url 'home' %}">主页 /a>：这里必须在urls.py中声明 对应的view 方法的 name='home'
5. h3>{{ blog.title }}</h3>：得到blog对象的title属性的内容
6. p>{{ blog.content|truncatechars:30 }}</p>：截取blog对象的content属性的内容（长度为30）
7. p>一共有{{ blogs|length }}篇博客</p>：得到该blogs对象的长度
8. p>发表日期：{{ blog.created_time|date:"Y-m-d H:n:s" }}</p>：得到blog对象的created_time属性格式化后的内容

## 2.5 使用 “数据库” 缓存

1. 先在setting.py末尾添加

   - ```python
      CACHES = {
         'default': {
         	'BACKEND': 'django.core.cache.backends.db.DatabaseCache',
         	'LOCATION': 'my_cache_table',
         }
     }
     ```

2. 在数据库中创建缓存表

   - py manage.py createcachetable

## 2.6 添加数据到数据库

### 示例

+ ```python
  from blog.models import Blog
  from blog.models import BlogType
  from django.contrib.auth.models import User
  for i in range(1,31)
      blog = Blog()
      blog.title = "test %d" % i
      blog.content = "content %d" % i
      blog.blog_type = BlogType.objects.all()[0]
      blog.author = User.objects.all()[0]
      blog.save()
  ```

## 2.7 分页器

### 分页器对象常用属性

1. paginator.count：得到文章数量
2. paginator.num_pages：得到总共页数
3. paginator.page_range：得到页数范围

### 示例

+ view.py

  ```python
  from django.core.paginator import Paginator
  from douban.models import FilmDetail
  
  
  # 首页电影信息分页显示
  def film_list(request, page_num):
  
      film_lists = FilmDetail.objects.order_by('-film_rate')  # 按照日期倒叙排序
  
      paginator = Paginator(film_lists, 15)  # 显示前15条数据
  
      page_num = 1 if page_num == "" else int(page_num)
  
      now_page = paginator.page(page_num)  # 返回第number页的page类实例对象
  
      page_list = []
      num_pages = paginator.num_pages  # 返回分页之后的总页数
      page_range = paginator.page_range  # 返回分页后的页码列表
  
      # 最多显示5个页码
      if num_pages >= 5:
          if 3 <= page_num <= num_pages - 2:
              page_list = page_range[page_num - 3:page_num + 2]
          elif page_num < 3:
              page_list = page_range[0:page_num + 2]
          elif page_num > num_pages - 2:
              page_list = page_range[page_num-3:num_pages]
      else:
          page_list = page_range
  
      context = {
          "now_page": now_page,  # 当前页码包含有15条数据的 paginator 对象
          "page_list": page_list,  # 页码列表
  
      }
  
      return render(request, "douban/film_list.html", context)
  ```

- html
  ```html
  <div class="row">
          <div class="col-sm-3 col-md-2 sidebar">
              <ul class="nav nav-sidebar">
                  <li class="active"><a href="{% url 'film_list' 1 %}">电影列表<span class="sr-only">(current)</span></a></li>
  
              </ul>
  
          </div>
          <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
  
  
              <h2 class="sub-header">电影列表</h2>
              <div class="table-responsive">
                  <table class="table table-striped">
                      <thead>
                      <tr>
                          <th>电影ID</th>
                          <th>电影名称</th>
                          <th>电影评分</th>
                          <th>评分分析</th>
                          <th>积极因素统计</th>
                          <th>消极因素统计</th>
                          <th>情感得分</th>
                          <th>电影详情</th>
                      </tr>
                      </thead>
                      <tbody id="film_list">
                      <!--<tr>
                          <td>1</td>
                          <td>Lorem</td>
                          <td>ipsum</td>
                          <td>dolor</td>
                          <td>sit</td>
                          <td>sit</td>
                      </tr>-->
                      {% for item in now_page %}
                          <tr>
                              <td>{{ item.film_id }}</td>
                              <td>{{ item.film_title }}</td>
                              <td>{{ item.film_rate }}</td>
                              <td>{{ item.film_result }}</td>
                              <td>{{ item.positive_emotion }}</td>
                              <td>{{ item.negative_emotion }}</td>
                              <td>{{ item.total_score }}</td>
                              <td><a href="{% url 'emotion_analysis' item.film_id %}">评论分析</a>&nbsp;<a href="{% url 'film_reviews' item.film_id 1 %}">查看影评</a></td>
                          </tr>
                      {% endfor %}
                      </tbody>
                  </table>
  
                  <div class="text-right">
                      {# 判断当前页是否有上一页#}
                      {% if now_page.has_previous %}
                          <a href="{% url 'film_list' now_page.previous_page_number %}" >
                              <span class="label label-info" >&laquo;</span></a>
                      {% endif %}
  
  
                      {# 循环遍历页码列表，并展示到底部#}
                      {% for num in page_list%}
                          {%if num == now_page.number%}
                              <a href="javascript:void(0)">
                                  <span class="label label-primary">{{ num }}</span>
                              </a>
                          {%else%}
                              <a href="{% url 'film_list' num %}">
                                  <span class="label label-info">{{ num }}</span>
                              </a>
                          {%endif%}
                      {% endfor %}
  
                      {#判断当前页是否有下一页#}
                      {% if now_page.has_next %}
                          <a href="{% url 'film_list' now_page.next_page_number %}" >
                              <span class="label label-info" >&raquo;</span>
                          </a>
                      {% endif %}
  
  
                  </div>
              </div>
          </div>
      </div>
  ```

## 2.8 django 使用 ajax

### 示例1：get 请求

+ ```javascript
  <script>
      //模糊查询
      function search_item(){
          const search_text = $("input.form-control").val()
          if(search_text == ""){
              $('#example').popover("show")
              self.setInterval("$('#example').popover('hide')",2000);
          }
          else{
              $.ajax({
                  url:'{% url 'search_item' %}',
                  type:'get',
                  data:{
                      'search_text':search_text,
                  },
                  success:function (json) {
                      //alert(json.data[0]['id']);
                      $("#film_list").empty();
                      $("div.text-right").empty();
  
                      for (let i=0; i<Object.keys(json.data).length; i++){
                          let tr = "<tr>";
                          tr += "<td>"+json.data[i]["film_id"]+"</td>";
                          tr += "<td>"+json.data[i]["film_title"]+"</td>";
                          tr += "<td>"+json.data[i]["film_rate"]+"</td>";
                          tr += "<td>"+json.data[i]["film_result"]+"</td>";
                          tr += "<td>"+json.data[i]["positive_emotion"]+"</td>";
                          tr += "<td>"+json.data[i]["negative_emotion"]+"</td>";
                          tr += "<td>"+json.data[i]["total_score"]+"</td>";
                          tr += '<td>' +
                              '<a href="/douban/emotion_analysis/film_id='+json.data[i]["film_id"]+'">评论分析</a>&nbsp;' +
                              '<a href="/douban/film_reviews/film_id='+json.data[i]["film_id"]+'/page=1">查看影评</a>' +
                              '</td>';
                          tr += "</tr>";
                          $("#film_list").append(tr);
                      }
                  }
              })
          }
      }
  
  </script>
  ```


### 示例2：post 请求

+ ```javascript
  $(function () {
     $.ajaxSetup({
         data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
     });
      
     $("#login").click(function () {
          var account = $("#account").val();
          var pwd = $("#pwd").val();
  
          $.ajax({
              type:"post",
              dataType:"json",
              data:{
                  account:account,
                  pwd:pwd
              },
              url:"{% url 'login' %}",
              success:function (ret) {
                  $("#result").html(ret)
              },
              error:function () {
                  alert('false');
              }
          })；
     });
  });        
  ```

## 2.9 利用 admin 管理自定义的表

### 示例1: 在对应 app 目录下的 admin.py 中对表进行绑定

+ ```python
  from django.contrib import admin
  
  # Register your models here.
  from .models import Model1
  from .models import Model2
  
  admin.site.register(Model1)
  admin.site.register(Model2)
  ```

### 示例2: admin 的其它设置

+ ```python
  from django.contrib import admin
  
  # Register your models here.
  from Test.models import Test1
  from Test.models import Test2
  
  
  class Test1Configuration(admin.ModelAdmin):
      #实现多列显示下面的列名和数据库里面的对应
      list_display = ('id', 'name')  # 参数必须是元组
      #实现可以直接在列表中修改项
      list_editable = ('name',)  # 参数必须是元组
      #实现模糊搜索,在里面有一个搜索框
      search_fields = ('id', 'name')  # 参数必须是元组
  
  
  # 第一个参数: model_name, 第二个参数自定义的 admin_class
  admin.site.register(Test1,Test1Configuration)  
  admin.site.register(Test2)
  ```

# 3. django 模型(models) 常用字段

## 3.1 models.AutoField　　

+ 自增列 = int(11) 参数说明
  + 如果没有的话，默认会生成一个名称为 id 的列    
  + 如果要显式的自定义一个自增列，必须设置primary_key=True。

## 3.2 models.CharField　

+ 字符串字段 参数说明
  + 必须设置max_length参数

## 3.3 models.BooleanField

+ 布尔类型=tinyint(1) 参数说明
  + 不能为空，可添加Blank=True

## 3.4 models.ComaSeparatedIntegerField

+ 用逗号分割的数字=varchar 参数说明
  + 继承CharField，所以必须有 max_lenght 参数

## 3.5 models.DateField

+ 日期类型 date 参数说明
  + DateField.auto_now：保存时自动设置该字段为现在日期，最后修改日期
  + DateField.auto_now_add：当该对象第一次被创建是自动设置该字段为现在日期，创建日期。

## 3.6 models.DateTimeField

+ 日期时间类型 datetime
+ 参数同 DateField

## 3.7 models.Decimal

+ 十进制小数类型 = decimal
+  DecimalField.max_digits：数字中允许的最大位数
+ DecimalField.decimal_places：存储的十进制位数

## 3.8 models.EmailField

+ 一个带有检查 Email 合法性的 CharField

## 3.9 models.FloatField

+ 浮点类型 = double

## 3.10 models.IntegerField　

+  整形

## 3.11 models.BigIntegerField　

+ 长整形

### 常用数字类型的 取值范围

+ ```python
  integer_field_ranges = {
  　　　　'SmallIntegerField': (-32768, 32767),
  　　　　'IntegerField': (-2147483648, 2147483647),
  　　　　'BigIntegerField': (-9223372036854775808, 9223372036854775807),
  　　　　'PositiveSmallIntegerField': (0, 32767),
  　　　　'PositiveIntegerField': (0, 2147483647),
  }
  ```

## 3.12 models.GenericIPAddressField

+ 一个带有检查 IP地址合法性的 CharField

## 3.13 models.NullBooleanField　

+ 允许为空的布尔类型

## 3.14 models.PositiveIntegerFiel

+  正整数

## 3.15 models.PositiveSmallIntegerField

+ 正 smallInteger

## 3.16 models.SlugField　

+ 减号、下划线、字母、数字

## 3.17 models.SmallIntegerField

+  数字

### 数据库中有关数字的字段主要有四种

+ tinyint、smallint、int、bigint

## 3.18 models.TextField

+ 大文本。默认对应的form标签是textarea

## 3.19 models.TimeField

+ 时间 HH:MM[:ss[.uuuuuu]]

## 3.20 models.URLField

+  一个带有URL合法性校验的CharField。

## 3.21 models.BinaryField　

+ 二进制
+ 存储二进制数据。不能使用filter函数获得QuerySet。

## 3.22 models.ImageField 

+ 图片
+ ImageField.height_field、ImageField.width_field：如果提供这两个参数，则图片将按提供的高度和宽度规格保存
+ 该字段要求 Python Imaging 库Pillow
+ 会检查上传的对象是否是一个合法图片

## 3.23 models.FileField(upload_to=None[, max_length=100, ** options])

+ 文件
+ FileField.upload_to：一个用于保存上传文件的本地文件系统路径，该路径由 MEDIA_ROOT 中设置
+ 这个字段不能设置primary_key和unique选项.在数据库中存储类型是varchar，默认最大长度为100

## 3.24 models.FilePathField(path=None[, math=None, recursive=False, max_length=100, **options])

+ FilePathField.path：文件的绝对路径，必填
+ FilePathField.match：用于过滤路径下文件名的正则表达式，该表达式将用在文件名上（不包括路径）。
+ FilePathField.recursive：True 或 False，默认为 False，指定是否应包括所有子目录的路径。
+ 例如：FilePathField(path="/home/images", match="foo.*", recursive=True)
  + 将匹配“/home/images/foo.gif”但不匹配“/home/images/foo/bar.gif”

# 4. django 模型(models) 字段常用参数

## 4.1 null

+ 如果是True，Django会在数据库中将此字段的值置为NULL，默认值是False

## 4.2 blank

+ 如果为True时 django的 Admin 中添加数据时可允许空值，可以不填。如果为False则必须填。默认是False。
+  null纯粹是与数据库有关系的。而blank是与页面必填项验证有关的

## 4.3 primary_key = False

+ 主键，对AutoField设置主键后，就会代替原来的自增 id 列

## 4.4 auto_now 和 auto_now_add

+ auto_now  自动创建---无论添加或修改，都是当前操作的时间
+ auto_now_add 自动创建---永远是创建时的时间

## 4.5 choices

+ 一个二维的元组被用作choices，如果这样定义，Django会select box代替普通的文本框，并且限定choices的值是元组中的值

+ ```python
  GENDER_CHOICE = (
              (u'M', u'Male'),
              (u'F', u'Female'),
  )
  ```

+ gender = models.CharField(max_length=2, choices = GENDER_CHOICE)

## 4.6 max_length

+  字段长度

## 4.7 default

+ 默认值

## 4.8 verbose_name

+ Admin中字段的显示名称，如果不设置该参数时，则与属性名。

## 4.9 db_column

+ 数据库中的字段名称

## 4.10 unique=True

+ 不允许重复

## 4.11 db_index = True

+ 数据库索引

## 4.12 editable=True

+ 在 django 的 Admin 里是否可编辑

## 4.13 error_messages=None

+ 错误提示

## 4.14 auto_created=False

+ 自动创建

## 4.15 help_text

+ 在Admin中提示帮助信息

## 4.16 validators = []

+ 验证器

## 4.17 upload-to

+ 文件上传时的保存上传文件的目录

# 5. django 模型（数据库）

## 5.1 获取对象

1. Person.objects.all()
2. Person.objects.all()[:10]
3. Person.objects.get(name=name)  # 获取单个对象

### 按条件查找

1. Person.objects.filter(name="abc")  # 等于Person.objects.filter(name__exact="abc") 名称严格等于 "abc" 的人

2. Person.objects.filter(name__iexact="abc")  # 名称为 abc 但是不区分大小写，可以找到 ABC, Abc, aBC，这些都符合条件

   

3. Person.objects.filter(name__contains="abc")  # 名称中包含 "abc"的人

4. Person.objects.filter(name__icontains="abc")  #名称中包含 "abc"，且abc不区分大小写

   

5. Person.objects.filter(name__regex="^abc")  # 正则表达式查询

6. Person.objects.filter(name__iregex="^abc")  # 正则表达式不区分大小写

### 按条件排除

1. Person.objects.exclude(name__contains="WZ")  # 排除包含 WZ 的Person对象
2. Person.objects.filter(name__contains="abc").exclude(age=23)  # 找出名称含有abc, 但是排除年龄是23岁的

## 5.2 增加对象

+ Person.objects.create(name=name,age=age)

### 防止重复

+ Person.objects.get_or_create(name="WZT", age=23)
+ 这种方法是防止重复很好的方法，但是速度要相对慢些，返回一个元组，第一个为Person对象，第二个为True或False, 新建时返回的是True, 已经存在时返回False.

## 5.3 删除对象

### 按条件删除

+ Person.objects.filter(name="abc").delete() # 删除 名称等于 "abc"的人

### 删除所有

+ Person.objects.all().delete() # 删除所有 Person 记录

## 5.4 更新对象

+ Person.objects.filter(name__contains="abc").update(name='xxx') # 名称中包含 "abc"的人 都改成 xxx

# 补充

## ORM

### 概念

+  Object/Relation Mapping: 对象/关系映射

### 作用

+ 将关系数据库中表中的记录映射成为对象，以对象的形式展现，程序员可以把对数据库的操作转化为对对象的操作。
+ 方便开发人员以面向对象的思想来实现对数据库的操作。

### 示例图

- ![](C:\Users\87143\Desktop\Notebooks\Python\images\orm_model.png)

## Django 的 MTV 架构

+ Model(模型)： 负责业务对象与数据库的对象(ORM)。
+ Template(模板)：负责如何把页面展示给用户。
+ View(视图)：负责业务逻辑，并在适当的时候调用Model和Template。
+ 此外，Django还有一个urls分发器，它的作用是将一个个URL的页面请求分发给不同的View处理，view再调用相应的Model和Templates。

### 示例图

+ ![](C:\Users\87143\Desktop\Notebooks\Python\images\django_mtv.png)